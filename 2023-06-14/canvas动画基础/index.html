<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>canvas动画基础 | zhangzhengsmiling</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">canvas动画基础</h1><a id="logo" href="/.">zhangzhengsmiling</a><p class="description">stand on eminence and become farsighted</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">canvas动画基础</h1><div class="post-meta">2023-06-14<span> | </span><span class="category"><a href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="ds-thread-count" href="/2023-06-14/canvas%E5%8A%A8%E7%94%BB%E5%9F%BA%E7%A1%80/#SOHUCS"><span id="changyan_count_unit" style="font-size: 15px; color: #6E7173;">0</span><span> 条评论</span></a><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js" async></script><div class="post-content"><h4 id="0-引言"><a href="#0-引言" class="headerlink" title="0. 引言"></a>0. 引言</h4><ul>
<li>本次分享主要涉及的是canvas相关的动画相关的思想，主要参考的书籍是《TypeScript图形学渲染实战 2D架构设计与实战》</li>
<li>由于本人对于动画只是初入门，有些地方的理解可能比较偏颇的地方，欢迎指正</li>
<li>canvas在平时写业务的时候可能触及到的不是特别多，可能很多同学对于基础的API了解都不是特别多；用canvas写动画的经历可能就更少了。本次分享不会涉及到过于细节的canvas绘制的API，主要还是聊聊canvas里面动画涉及的一些思想<a id="more"></a>

</li>
</ul>
<h4 id="1-requestAnimationFrame"><a href="#1-requestAnimationFrame" class="headerlink" title="1. requestAnimationFrame"></a>1. requestAnimationFrame</h4><p><a target="_blank" rel="noopener" href="https://hentaicracker.github.io/2020/rAF.html">https://hentaicracker.github.io/2020/rAF.html</a></p>
<p>定时器是javascript动画的核心技术。一般情况下，javascript动画一般都是通过在定时器中不断改变元素的状态（位置，颜色等属性）来实现。</p>
<p>浏览器中比较常用的定时器技术包括：setTimeout/setInterval/requestAnimationFrame</p>
<ul>
<li><h5 id="为什么要使用requestAnimationFrame"><a href="#为什么要使用requestAnimationFrame" class="headerlink" title="为什么要使用requestAnimationFrame"></a>为什么要使用requestAnimationFrame</h5><p><strong><em>setInterval/setTimeout动画存在的问题：</em></strong></p>
<ol>
<li><p>首先使用setTimeout和setInterval存在计时不准确的问题。callback只是在指定时间后，被加入到任务队列中等待被调度，因此，回调执行的时间可能会大于设定的时间。这块有疑问的话，可以参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33058983">事件循环机制</a></p>
</li>
<li><p>setInterval指定的循环周期与页面的刷新频率不同步问题。假设我们暂时不考路setInterval定时器本身的误差，此时我们需要完成一个动画，使得小球以10px/10ms的速度运动</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ele = &#123;&#125;;</span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 更新元素的坐标</span></span><br><span class="line">  ele.x += <span class="number">10</span>;</span><br><span class="line">  <span class="comment">// 绘制元素</span></span><br><span class="line">  render(ele);</span><br><span class="line">&#125;, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>目前大多数电脑的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B8%A7%E7%8E%87">屏幕刷新频率</a>为60Hz，也就是我们理解的1秒中内绘制60帧,任意两帧之间的间隔为16.7ms</p>
<p><img src="/img/canvas-anim/image-20210922110602810.png" alt="image-20210922110602810"></p>
<p>从上面的渲染时间线中我们可以看到，在第一帧的时候，元素向右移动了10px，而第二帧移动了20px，第三帧移动了20px，后面会产生一个循环。</p>
<p>在渲染第二帧时，setInterval执行了两次，但只绘制了一帧，因而导致了其中的一个状态帧丢失了，因此可能会产生卡顿或者跳帧。但在实际中肉眼可能意识不到丢帧了，但总体动画的流畅度上还是会有一些影响的。</p>
</li>
</ol>
<p><strong><em>requestAnimationFrame如何解决上述问题</em></strong></p>
<blockquote>
<p><strong><code>window.requestAnimationFrame()</code></strong> 告诉浏览器——你希望执行一个动画，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画。该方法需要传入一个回调函数作为参数，该回调函数会在浏览器下一次重绘之前执行</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame">https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame</a></p>
</blockquote>
<ol>
<li>根据MDN上的文档可以知道，requestAnimationFrame执行的时机是在每一次页面重绘之前；也就是在每一帧重绘之前调用，也就是基本可以稳定和页面的刷新频率保持一致。每隔16.7ms会执行回调函数</li>
<li>requestAnimaitionFrame执行的频率与屏幕刷新频率是保持一致的。虽然无法灵活控制执行时间间隔，但是可以通过两帧之间的时间间隔去计算每一帧的偏移或者动画移动速度；同时也可以避免出现跳帧的状况，动画整体上看起来会更加流畅一些。</li>
</ol>
</li>
<li><h5 id="requestAnimationFrame用法"><a href="#requestAnimationFrame用法" class="headerlink" title="requestAnimationFrame用法"></a>requestAnimationFrame用法</h5><blockquote>
<p>函数签名：</p>
<p>window.requestAnimationFrame: (callback) =&gt; number;</p>
<p>callback：</p>
<p>下一次重绘之前更新动画帧所调用的函数(即上面所说的回调函数)。该回调函数会被传入<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp"><code>DOMHighResTimeStamp</code></a>参数，该参数与<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/now"><code>performance.now()</code></a>的返回值相同，它表示<code>requestAnimationFrame()</code> 开始去执行回调函数的时刻。</p>
<p>返回值：</p>
<p>一个 <code>long</code> 整数，请求 ID ，是回调列表中唯一的标识。是个非零值，没别的意义。你可以传这个值给 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/cancelAnimationFrame"><code>window.cancelAnimationFrame()</code></a> 以取消回调函数。</p>
</blockquote>
<ol>
<li><p>CASE One:</p>
<p>callback不需要传参</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> callback = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">  requestAnimationFrame(callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requestAnimationFrame(callback);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>CASE Two：</p>
<p>callback需要传参,匿名函数包裹</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> step = <span class="function">(<span class="params">elapsedMsec, diffMsec</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">  requestAnimationFrame(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    step(elapsedMsec, diffMsec);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">step(<span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>calcelAnimationFrame</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 启动动画循环的基本结构，通过requestAnimationFrame重复调用step函数</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> requestAnimationFrameID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> step = <span class="function">(<span class="params">elapsedMsec, diffMsec</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">  requestAnimationFrameID = requestAnimationFrame(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    step(elapsedMsec, diffMsec);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> startAnim = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  requestAnimationFrameID = requestAnimationFrame(</span><br><span class="line">  	step(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stopAnim = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cancelAnimationFrame(requestAnimationFrameID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-canvas中的save和restore"><a href="#2-canvas中的save和restore" class="headerlink" title="2. canvas中的save和restore"></a>2. canvas中的save和restore</h4></li>
<li><h5 id="绘图状态"><a href="#绘图状态" class="headerlink" title="绘图状态"></a>绘图状态</h5><p>所谓绘图状态，其实主要指的是canvas绘制的属性，即Canvas如何进行下一步的绘制（例如用什么颜色，线条粗细，坐标系等等）</p>
<p>绘图状态主要包含：矩阵变换状态、剪切区域、CanvasContext绘制相关的属性</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>strokeStyle</td>
<td><code>#000000</code></td>
<td>指定线段颜色</td>
</tr>
<tr>
<td>fillStyle</td>
<td><code>#000000</code></td>
<td>填充路径的当前的颜色、模式或渐变</td>
</tr>
<tr>
<td>globalCompositeOperation</td>
<td><code>source-over</code></td>
<td>指定颜色如何与画布上已有颜色组合（合成）</td>
</tr>
<tr>
<td>lineCap</td>
<td><code>butt</code></td>
<td>指定线段端点的绘制方式</td>
</tr>
<tr>
<td>lineJoin</td>
<td><code>miter</code></td>
<td>指定线段端点的绘制方式</td>
</tr>
<tr>
<td>lineWidth</td>
<td>1</td>
<td>绘制线段的宽度</td>
</tr>
<tr>
<td>miterLimit</td>
<td>10</td>
<td>当 <code>lineJoin</code> 为 <code>miter</code> 时，这个属性指定斜连接长度和二分之一线宽的最大比率</td>
</tr>
<tr>
<td>shadowColor</td>
<td>rgba(0, 0, 0, 0)</td>
<td>指定阴影颜色</td>
</tr>
<tr>
<td>shadowBlur</td>
<td>0</td>
<td>指定阴影模糊度</td>
</tr>
<tr>
<td>shadowOffsetX</td>
<td>0</td>
<td>指定阴影水平偏移值</td>
</tr>
<tr>
<td>shadowOffsetY</td>
<td>0</td>
<td>指定阴影垂直偏移值</td>
</tr>
</tbody></table>
</li>
<li><h5 id="绘图状态栈-save和restore的工作机制"><a href="#绘图状态栈-save和restore的工作机制" class="headerlink" title="绘图状态栈(save和restore的工作机制)"></a>绘图状态栈(save和restore的工作机制)</h5><p>canvas中的绘图状态栈可使用以下代码进行模拟，其用法与CanvasContext的API基本保持一致</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> strokeStyle: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">public</span> fillStyle: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">public</span> lineWidth: <span class="built_in">number</span>;</span><br><span class="line">  <span class="comment">// ....other props</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.strokeStyle = <span class="string">&#x27;#000000&#x27;</span>;</span><br><span class="line">    <span class="built_in">this</span>.fillStyle = <span class="string">&#x27;#000000&#x27;</span>;</span><br><span class="line">    <span class="built_in">this</span>.lineWidth = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// ... default props</span></span><br><span class="line">  &#125;</span><br><span class="line">  clone(): RenderState &#123;</span><br><span class="line">    <span class="keyword">const</span> rs = <span class="keyword">new</span> RenderState();</span><br><span class="line">    rs.strokeStyle = <span class="built_in">this</span>.strokeStyle;</span><br><span class="line">    rs.fillStyle = <span class="built_in">this</span>.fillStyle;</span><br><span class="line">    rs.lineWidth = <span class="built_in">this</span>.lineWidth;</span><br><span class="line">    <span class="comment">// ... other props</span></span><br><span class="line">    <span class="keyword">return</span> rs;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderStateStack</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> _stack: RenderState[] = [</span><br><span class="line">    <span class="keyword">new</span> RenderState()</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">get</span> <span class="title">current</span>(): <span class="title">RenderState</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._stack[<span class="built_in">this</span>._stack.length - <span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="title">save</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._stack.push(</span><br><span class="line">      <span class="built_in">this</span>._stack[<span class="built_in">this</span>._stack.length - <span class="number">1</span>].clone()</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="title">restore</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._stack.pop();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// getters and setters...</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title">strokeStyle</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.current.strokeStyle;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">strokeStyle</span>(<span class="params">strokeStyle: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.current.strokeStyle = strokeStyle;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">fillStyle</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.current.fillStyle;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">fillStyle</span>(<span class="params">fillStyle: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.current.fillStyle = fillStyle;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">lineWidth</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.current.lineWidth;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">lineWidth</span>(<span class="params">strokeStyle: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.current.lineWidth = strokeStyle;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过一个例子来理解下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> renderStateStack = <span class="keyword">new</span> RenderStateStack();</span><br><span class="line"><span class="built_in">console</span>.log(renderStateStack.current); <span class="comment">// #000000,#000000,1</span></span><br><span class="line">renderStateStack.strokeStyle = <span class="string">&#x27;orange&#x27;</span>;</span><br><span class="line">renderStateStack.lineWidth = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">console</span>.log(renderStateStack.current); <span class="comment">// orange, #000000, 5</span></span><br><span class="line"></span><br><span class="line">renderStateStack.save();</span><br><span class="line">renderStateStack.fillStyle = <span class="string">&#x27;purple&#x27;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(renderStateStack.current); <span class="comment">// orange, purple, 5</span></span><br><span class="line"></span><br><span class="line">renderStateStack.save();</span><br><span class="line">renderStateStack.fillStyle = <span class="string">&#x27;blue&#x27;</span>;</span><br><span class="line">renderStateStack.strokeStyle = <span class="string">&#x27;green&#x27;</span>;</span><br><span class="line">renderStateStack.lineWidth = <span class="number">4</span>;</span><br><span class="line"><span class="built_in">console</span>.log(renderStateStack.current); <span class="comment">// green, blue, 4</span></span><br><span class="line">renderStateStack.restore();</span><br><span class="line"></span><br><span class="line">renderStateStack.restore();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(renderStateStack.current); <span class="comment">// orange, #000000, 5</span></span><br></pre></td></tr></table></figure>
<h4 id="3-动画控制器Application类"><a href="#3-动画控制器Application类" class="headerlink" title="3. 动画控制器Application类"></a>3. 动画控制器Application类</h4></li>
<li><h5 id="Application类功能"><a href="#Application类功能" class="headerlink" title="Application类功能"></a>Application类功能</h5><ol>
<li>启动动画循环和停止动画循环，start函数和stop函数</li>
<li>计算动画持续时间elapsedMsec和两次绘制间隔diffMsec(step函数)</li>
<li>基于elapsedMsec和diffMsec进行动画更新(update函数)和绘制(render函数)</li>
</ol>
</li>
<li><p>Application类基础功能实现代码如下：</p>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">  _canvas: HTMLCanvasElement;</span><br><span class="line">  _ctx: CanvasRenderingContext2D;</span><br><span class="line">  <span class="comment">// 动画开始时间</span></span><br><span class="line">  _beginTime: <span class="built_in">number</span> = -<span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 动画启停标记位</span></span><br><span class="line">  _isRunning: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// 从动画开始，动画当前持续时长</span></span><br><span class="line">  _elapsedMsec: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 当前帧绘制与前一帧之间的时间间隔</span></span><br><span class="line">  _diffMsec: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">  _requestAnimationFrameID: <span class="built_in">number</span> = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">canvas: HTMLCanvasElement</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._canvas = canvas;</span><br><span class="line">    <span class="built_in">this</span>._ctx = canvas.getContext(<span class="string">&#x27;2d&#x27;</span>) <span class="keyword">as</span> CanvasRenderingContext2D;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 启动动画</span></span><br><span class="line">  <span class="keyword">public</span> start(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>._isRunning) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;application is already running...&#x27;</span>);</span><br><span class="line">    <span class="built_in">this</span>._isRunning = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">this</span>._beginTime = <span class="keyword">new</span> <span class="built_in">Date</span>().valueOf();</span><br><span class="line">    <span class="built_in">this</span>._requestAnimationFrameID = requestAnimationFrame(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.step(<span class="built_in">this</span>._elapsedMsec, <span class="built_in">this</span>._diffMsec);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 停止动画</span></span><br><span class="line">  <span class="keyword">public</span> stop():<span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>._isRunning) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;application is already stoped...&#x27;</span>);</span><br><span class="line">    cancelAnimationFrame(<span class="built_in">this</span>._requestAnimationFrameID);</span><br><span class="line">    <span class="built_in">this</span>._beginTime = -<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">this</span>._isRunning = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>._elapsedMsec = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">this</span>._diffMsec = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> step(elapsedMsec: <span class="built_in">number</span>, <span class="attr">diffMsec</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.update(elapsedMsec, diffMsec);</span><br><span class="line">    <span class="built_in">this</span>.render();</span><br><span class="line">    <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>().valueOf();</span><br><span class="line">    <span class="built_in">this</span>._elapsedMsec = now - <span class="built_in">this</span>._beginTime;</span><br><span class="line">    <span class="built_in">this</span>._diffMsec = <span class="built_in">this</span>._elapsedMsec - elapsedMsec;</span><br><span class="line">    <span class="built_in">this</span>._requestAnimationFrameID = requestAnimationFrame(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.step(<span class="built_in">this</span>._elapsedMsec, <span class="built_in">this</span>._diffMsec);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 更新动画状态</span></span><br><span class="line">  <span class="keyword">protected</span> update(elapsedMsec: <span class="built_in">number</span>, <span class="attr">diffMsec</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;sub class should override update method...&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 绘制</span></span><br><span class="line">  <span class="keyword">protected</span> render(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;sub class should override render method...&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Application;</span><br></pre></td></tr></table></figure>
<ul>
<li><h5 id="Application类子类继承"><a href="#Application类子类继承" class="headerlink" title="Application类子类继承"></a>Application类子类继承</h5><p>用一个简单的例子来看下Application类的扩展方式</p>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">  <span class="comment">// global状态</span></span><br><span class="line">  _x: <span class="built_in">number</span> = <span class="number">200</span>;</span><br><span class="line">  _y: <span class="built_in">number</span> = <span class="number">200</span>;</span><br><span class="line">  <span class="comment">// rect1状态</span></span><br><span class="line">  rect1: <span class="built_in">any</span> = &#123;</span><br><span class="line">    width: <span class="number">100</span>,</span><br><span class="line">    height: <span class="number">100</span>,</span><br><span class="line">    strokeStyle: <span class="string">&#x27;orange&#x27;</span>,</span><br><span class="line">    rotate: <span class="number">0</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// rect2状态</span></span><br><span class="line">  rect2: <span class="built_in">any</span> = &#123;</span><br><span class="line">    width: <span class="number">40</span>,</span><br><span class="line">    height: <span class="number">40</span>,</span><br><span class="line">    strokeStyle: <span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">    rotate: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params">elapsedMsec: <span class="built_in">number</span>, diffMsec: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.rect1.rotate += <span class="built_in">Math</span>.PI * <span class="number">0.01</span>;</span><br><span class="line">    <span class="built_in">this</span>.rect2.rotate -= <span class="built_in">Math</span>.PI * <span class="number">0.02</span>;</span><br><span class="line">    <span class="built_in">this</span>._x = (<span class="built_in">this</span>._x + <span class="number">1</span>) % (<span class="built_in">this</span>._canvas.width / <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="built_in">this</span>._ctx;</span><br><span class="line">    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">this</span>._canvas.width, <span class="built_in">this</span>._canvas.height);</span><br><span class="line">    ctx.save();</span><br><span class="line">      <span class="comment">// outer</span></span><br><span class="line">      ctx.translate(<span class="built_in">this</span>._x, <span class="built_in">this</span>._y);</span><br><span class="line">      ctx.save();</span><br><span class="line">        <span class="comment">// rect1</span></span><br><span class="line">        <span class="keyword">const</span> rect1 = <span class="built_in">this</span>.rect1;</span><br><span class="line">        ctx.strokeStyle = rect1.strokeStyle;</span><br><span class="line">        ctx.rotate(rect1.rotate);</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.rect(-rect1.width / <span class="number">2</span>, -rect1.height / <span class="number">2</span>, rect1.width, rect1.height);</span><br><span class="line">        ctx.stroke();</span><br><span class="line">      ctx.restore();</span><br><span class="line">      ctx.save();</span><br><span class="line">        <span class="comment">// rect2</span></span><br><span class="line">        <span class="keyword">const</span> rect2 = <span class="built_in">this</span>.rect2;</span><br><span class="line">        ctx.strokeStyle = rect2.strokeStyle;</span><br><span class="line">        ctx.rotate(rect2.rotate);</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.rect(-rect2.width / <span class="number">2</span>, -rect2.height / <span class="number">2</span>, rect2.width, rect2.height);</span><br><span class="line">        ctx.stroke();</span><br><span class="line">      ctx.restore();</span><br><span class="line">    ctx.restore();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/img/canvas-anim/2021-09-22 11.17.31.png" alt="2021-09-22 11.17.31" style="zoom: 33%;" />

<ol>
<li>第一层动画，两个矩形作为一个整体向右做translate</li>
<li>第二层动画，橙色矩形顺时针旋转</li>
<li>第三层动画，红色矩形逆时针旋转</li>
</ol>
<ul>
<li><h5 id="从线条动画聊聊动画的绘制思想"><a href="#从线条动画聊聊动画的绘制思想" class="headerlink" title="从线条动画聊聊动画的绘制思想"></a>从线条动画聊聊动画的绘制思想</h5><p>线条动画的逻辑比较简单，可以拿画线条的逻辑，去延伸下动画绘制的思想</p>
<p><u>思想一：</u></p>
<ul>
<li><p>动画中每一帧渲染之前，将前一帧的内容全部清空，然后根据状态绘制当前帧的内容</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  begin = &#123;</span><br><span class="line">    x: <span class="number">10</span>,</span><br><span class="line">    y: <span class="number">10</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  end = &#123;</span><br><span class="line">    x: <span class="number">10</span>,</span><br><span class="line">    y: <span class="number">10</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params">elapsedMsec: <span class="built_in">number</span>, diffMsec: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.end.x &gt; <span class="number">400</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">this</span>.end.x += <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">this</span>.end.y += <span class="number">5</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">this</span>._canvas.width, <span class="built_in">this</span>._canvas.height);</span><br><span class="line">    <span class="comment">// 绘制当前帧的内容</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><u>思想二：</u></p>
</li>
<li><p>不清空前一帧内容</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  begin = &#123;</span><br><span class="line">    x: <span class="number">10</span>,</span><br><span class="line">    y: <span class="number">10</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  end = &#123;</span><br><span class="line">    x: <span class="number">10</span>,</span><br><span class="line">    y: <span class="number">10</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params">elapsedMsec: <span class="built_in">number</span>, diffMsec: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// method 2</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.end.x &gt; <span class="number">400</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 记忆前一帧的结束点</span></span><br><span class="line">    <span class="built_in">this</span>.begin.x = <span class="built_in">this</span>.end.x;</span><br><span class="line">    <span class="built_in">this</span>.begin.y = <span class="built_in">this</span>.end.y;</span><br><span class="line">    <span class="built_in">this</span>.end.x += <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">this</span>.end.y += <span class="number">5</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 绘制</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p> <strong>可以考虑下这两种方式哪一种更好一些?</strong></p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="4-canvas事件模拟"><a href="#4-canvas事件模拟" class="headerlink" title="4. canvas事件模拟"></a>4. canvas事件模拟</h4><ul>
<li><h4 id="addEventListener"><a href="#addEventListener" class="headerlink" title="addEventListener"></a><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener">addEventListener</a></h4><blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">target.addEventListener(type, listener, options);</span><br><span class="line">target.addEventListener(type, listener, useCapture);</span><br><span class="line">target.addEventListener(type, listener, useCapture, wantsUntrusted );  <span class="comment">// Gecko/Mozilla only</span></span><br></pre></td></tr></table></figure>
<p>针对上述api，主要想来聊聊第二个参数，listener</p>
</blockquote>
<ol>
<li><p>第一种用法就是我们平时比较常用的listener以回调函数的方式传入。</p>
<p>这种调用方式是我们平时用的比较多的，在EventTarget对象上触发事件时，会调用回调函数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...do something</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><p>第二种用法是传入一个Object类型的listener，要求listener必须实现handleEvent函数</p>
<ul>
<li>js写法，只要对象中包含handleEvent函数即可</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elo = &#123;</span><br><span class="line">  <span class="function"><span class="title">handleEvent</span>(<span class="params">evt</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;event trigger&#x27;</span>, evt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">&#x27;click&#x27;</span>, elo);</span><br></pre></td></tr></table></figure>
<ul>
<li>ts写法，可以与js相同，但一般会考虑用类的方式创建EventListener对象</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EventListenerObject是typescript自带的类型，在lib.dom.d.ts中声明</span></span><br><span class="line"><span class="comment">// interface EventListenerObject &#123;</span></span><br><span class="line"><span class="comment">//    handleEvent(object: Event): void;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CanvasEventListener</span> <span class="title">implements</span> <span class="title">EventListenerObject</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">handleEvent</span>(<span class="params">evt: Event</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;event trigger&#x27;</span>, evt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> elo = <span class="keyword">new</span> CanvasEventListener();</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">&#x27;click&#x27;</span>, elo);</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>CanvasEventListener</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CanvasEventListener</span> <span class="title">implements</span> <span class="title">EventListenerObject</span> </span>&#123;</span><br><span class="line">  _canvas: HTMLCanvasElement;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">canvas: HTMLCanvasElement</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._canvas = canvas;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> handleEvent(evt: Event): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span>(evt.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;mousedown&#x27;</span>:</span><br><span class="line">        <span class="built_in">this</span>.dispatchMouseDown(</span><br><span class="line">          <span class="built_in">this</span>._event2CanvasMouseEvent(evt)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;mouseup&#x27;</span>:</span><br><span class="line">        <span class="built_in">this</span>.dispatchMouseUp(</span><br><span class="line">          <span class="built_in">this</span>._event2CanvasMouseEvent(evt)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;mousemove&#x27;</span>:</span><br><span class="line">        <span class="built_in">this</span>.dispatchMouseUp(</span><br><span class="line">          <span class="built_in">this</span>._event2CanvasMouseEvent(evt)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// case &#x27;mousesdrag&#x27;</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;keydown&#x27;</span>:</span><br><span class="line">        <span class="built_in">this</span>.dispatchKeyDown(</span><br><span class="line">          <span class="built_in">this</span>._event2CanvasKeyBoardEvent(evt)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;keyup&#x27;</span>:</span><br><span class="line">        <span class="built_in">this</span>.dispatchKeyUp(</span><br><span class="line">          <span class="built_in">this</span>._event2CanvasKeyBoardEvent(evt)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;keypress&#x27;</span>:</span><br><span class="line">        <span class="built_in">this</span>.dispatchKeyPress(</span><br><span class="line">          <span class="built_in">this</span>._event2CanvasKeyBoardEvent(evt)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> dispatchMouseDown(evt: CanvasMouseEvent): <span class="built_in">void</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">protected</span> dispatchMouseUp(evt:CanvasMouseEvent): <span class="built_in">void</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">protected</span> dispatchMouseMove(evt: CanvasMouseEvent): <span class="built_in">void</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">protected</span> dispatchMouseDrag(evt: CanvasMouseEvent): <span class="built_in">void</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">protected</span> dispatchKeyDown(evt: CanvasKeyBoardEvent): <span class="built_in">void</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">protected</span> dispatchKeyUp(evt: CanvasKeyBoardEvent): <span class="built_in">void</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">protected</span> dispatchKeyPress(evt: CanvasKeyBoardEvent): <span class="built_in">void</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">_viewportPos2CanvasPos</span>(<span class="params">evt: MouseEvent</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>._canvas) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;canvas is not an element&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> bounds: ClientRect = <span class="built_in">this</span>._canvas.getBoundingClientRect();</span><br><span class="line">    <span class="keyword">const</span> x = evt.clientX - bounds.left;</span><br><span class="line">    <span class="keyword">const</span> y = evt.clientY - bounds.top;</span><br><span class="line">    <span class="keyword">return</span> Vec2.create(x, y);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> _event2CanvasMouseEvent(evt: Event): CanvasMouseEvent &#123;</span><br><span class="line">    <span class="keyword">const</span> event = evt <span class="keyword">as</span> MouseEvent;</span><br><span class="line">    <span class="keyword">const</span> bounds = <span class="built_in">this</span>._viewportPos2CanvasPos(event);</span><br><span class="line">    <span class="keyword">const</span> canvasEvt = <span class="keyword">new</span> CanvasMouseEvent(</span><br><span class="line">      bounds,</span><br><span class="line">      event.button,</span><br><span class="line">      event.altKey,</span><br><span class="line">      event.shiftKey,</span><br><span class="line">      event.ctrlKey</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> canvasEvt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> _event2CanvasKeyBoardEvent(evt: Event): CanvasKeyBoardEvent &#123;</span><br><span class="line">    <span class="keyword">let</span> event = evt <span class="keyword">as</span> KeyboardEvent;</span><br><span class="line">    <span class="keyword">const</span> canvasEvt = <span class="keyword">new</span> CanvasKeyBoardEvent(</span><br><span class="line">      event.key,</span><br><span class="line">      event.code,</span><br><span class="line">      event.altKey,</span><br><span class="line">      event.shiftKey,</span><br><span class="line">      event.ctrlKey</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> canvasEvt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> listener = <span class="keyword">new</span> CanvasEventListener();</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</div><div class="tags"><a href="/tags/%E5%8A%A8%E7%94%BB/"><i class="fa fa-tag"></i>动画</a><a href="/tags/canvas/"><i class="fa fa-tag"></i>canvas</a></div><div class="post-nav"><a class="pre" href="/2023-11-03/%E6%A0%91%E7%9A%84%E9%81%8D%E5%8E%86/">树的遍历</a><a class="next" href="/2023-04-30/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/">二叉搜索树</a></div><div id="SOHUCS" sid="1686702313746"></div><script>(function(){var appid='cyviQPbMk';var conf='prod_05b30768a3e1678744671be122542ed1';var width=window.innerWidth||document.documentElement.clientWidth;if(width<960){window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id='+appid+'&conf='+conf+'"><\/script>')}else{var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})})}})()
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://zhangzhengsmiling.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%8B%E8%AF%95/">测试</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" style="font-size: 15px;">单元测试</a> <a href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" style="font-size: 15px;">单点登录</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/" style="font-size: 15px;">服务端渲染</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/%E5%8A%A8%E7%94%BB/" style="font-size: 15px;">动画</a> <a href="/tags/canvas/" style="font-size: 15px;">canvas</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/" style="font-size: 15px;">二叉搜索树</a> <a href="/tags/%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96/" style="font-size: 15px;">算法优化</a> <a href="/tags/%E6%A0%91/" style="font-size: 15px;">树</a> <a href="/tags/%E5%A0%86/" style="font-size: 15px;">堆</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023-12-30/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/">服务端渲染</a></li><li class="post-list-item"><a class="post-list-link" href="/2023-11-03/%E6%A0%91%E7%9A%84%E9%81%8D%E5%8E%86/">树的遍历</a></li><li class="post-list-item"><a class="post-list-link" href="/2023-06-14/canvas%E5%8A%A8%E7%94%BB%E5%9F%BA%E7%A1%80/">canvas动画基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2023-04-30/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/">二叉搜索树</a></li><li class="post-list-item"><a class="post-list-link" href="/2022-12-21/%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/">优先队列</a></li><li class="post-list-item"><a class="post-list-link" href="/2022-10-09/%E4%BB%8E%E7%AE%80%E5%8D%95%E7%9A%84case%E8%AE%B2%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96--%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/">从简单的case讲算法优化--斐波那契数列</a></li><li class="post-list-item"><a class="post-list-link" href="/2022-01-23/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">单元测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2021-09-11/%E5%9B%BE%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F/">图表数据格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2021-09-01/nginx/">Nginx简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2020-10-10/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">单点登录</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/zhangzhengsmiling" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">zhangzhengsmiling.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>